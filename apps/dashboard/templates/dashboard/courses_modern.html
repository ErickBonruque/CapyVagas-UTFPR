{% extends 'dashboard/base_modern.html' %}

{% block page_title %}Gerenciar Cursos{% endblock %}

{% block content %}
<div class="space-y-6" x-data="coursesManager()" x-cloak>
    <!-- Header com ações -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Cursos</h2>
            <p class="text-sm text-gray-600 mt-1">Gerencie os cursos e seus termos de busca de vagas</p>
        </div>
        <button 
            @click="openCreateModal()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Novo Curso</span>
        </button>
    </div>

    <!-- Grid de cursos -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for course in courses %}
        <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-lg font-semibold text-gray-900">{{ course.name }}</h3>
                            {% if course.is_active %}
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">Ativo</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded-full">Inativo</span>
                            {% endif %}
                        </div>
                        {% if course.code %}
                        <p class="text-sm text-gray-500 mt-1">Código: {{ course.code }}</p>
                        {% endif %}
                        {% if course.description %}
                        <p class="text-sm text-gray-600 mt-2 line-clamp-2">{{ course.description }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                            {{ course.search_terms.count }} termo(s)
                        </span>
                        <a 
                            href="{% url 'course_detail' course.id %}" 
                            class="text-blue-600 hover:text-blue-700 font-medium"
                        >
                            Gerenciar →
                        </a>
                    </div>
                </div>
                
                <div class="mt-4 flex items-center space-x-2">
                    <button 
                        @click="toggleActive({{ course.id }}, {{ course.is_active|lower }})"
                        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                    >
                        {% if course.is_active %}Desativar{% else %}Ativar{% endif %}
                    </button>
                    <button 
                        @click="editCourse({{ course.id }})"
                        class="flex-1 px-3 py-2 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors"
                    >
                        Editar
                    </button>
                    <button 
                        @click="deleteCourse({{ course.id }}, '{{ course.name }}')"
                        class="px-3 py-2 text-sm text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full bg-white rounded-lg shadow p-12 text-center">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhum curso cadastrado</h3>
            <p class="text-gray-600 mb-6">Comece criando seu primeiro curso para configurar as buscas de vagas</p>
            <button 
                @click="openCreateModal()"
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
            >
                Criar Primeiro Curso
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Modal de criação de curso -->
    <div
        x-show="showCreateModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        x-transition
    >
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6" @click.away="closeCreateModal()">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900">Novo curso</h3>
                    <p class="text-sm text-gray-600">Cadastre um curso e defina seus termos de busca.</p>
                </div>
                <button class="text-gray-400 hover:text-gray-600" @click="closeCreateModal()">✕</button>
            </div>

            <div class="mt-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome</label>
                    <input type="text" x-model="newCourse.name" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: Engenharia de Software" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Código (opcional)</label>
                    <input type="text" x-model="newCourse.code" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: COENS" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea x-model="newCourse.description" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" rows="3" placeholder="Resumo para identificar o curso e a busca."></textarea>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="is_active" x-model="newCourse.is_active" class="h-4 w-4 text-green-600 border-gray-300 rounded" checked />
                    <label for="is_active" class="text-sm text-gray-700">Ativo</label>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 rounded-lg border" @click="closeCreateModal()">Cancelar</button>
                <button
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-60"
                    :disabled="isSubmitting"
                    @click="createCourse()"
                >
                    <span x-show="!isSubmitting">Salvar curso</span>
                    <span x-show="isSubmitting">Salvando...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Função auxiliar para obter CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function coursesManager() {
    return {
        showCreateModal: false,
        isSubmitting: false,
        newCourse: {
            name: '',
            code: '',
            description: '',
            is_active: true,
        },
        openCreateModal() {
            this.showCreateModal = true;
        },
        closeCreateModal() {
            this.showCreateModal = false;
            this.newCourse = { name: '', code: '', description: '', is_active: true };
        },
        async createCourse() {
            if (!this.newCourse.name) {
                showToast('Informe o nome do curso', 'error');
                return;
            }
            this.isSubmitting = true;
            try {
                const response = await fetch('/api/courses/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(this.newCourse),
                });
                if (!response.ok) {
                    showToast('Erro ao criar curso', 'error');
                    return;
                }
                showToast('Curso criado com sucesso', 'success');
                setTimeout(() => window.location.reload(), 800);
            } catch (error) {
                showToast('Erro ao criar curso', 'error');
            } finally {
                this.isSubmitting = false;
            }
        },
        editCourse(id) {
            window.location.href = `/admin/courses/course/${id}/change/`;
        },
        async toggleActive(id, currentState) {
            try {
                const response = await fetch(`/api/courses/${id}/toggle_active/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                const data = await response.json();
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showToast('Erro ao alterar status do curso', 'error');
            }
        },
        deleteCourse(id, name) {
            if (confirm(`Tem certeza que deseja deletar o curso "${name}"? Esta ação não pode ser desfeita.`)) {
                fetch(`/api/courses/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(() => {
                    showToast('Curso deletado com sucesso', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(() => {
                    showToast('Erro ao deletar curso', 'error');
                });
            }
        }
    }
}
</script>
{% endblock %}
