{% extends 'dashboard/base_modern.html' %}

{% block page_title %}Histórico de Interações{% endblock %}

{% block content %}
<div class="space-y-6" x-data="interactionsManager()">
    <!-- Filtros -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Filtros</h3>
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                <select name="days" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="1" {% if days == 1 %}selected{% endif %}>Últimas 24h</option>
                    <option value="7" {% if days == 7 %}selected{% endif %}>Últimos 7 dias</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>Últimos 30 dias</option>
                    <option value="0">Tudo</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                <select name="type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos</option>
                    <option value="RECEIVED" {% if message_type == 'RECEIVED' %}selected{% endif %}>Recebidas</option>
                    <option value="SENT" {% if message_type == 'SENT' %}selected{% endif %}>Enviadas</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                <input 
                    type="text" 
                    name="search" 
                    value="{{ search }}"
                    placeholder="Telefone, RA ou mensagem..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>
            
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Filtrar
                </button>
            </div>
        </form>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Total de Mensagens</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ stats.total }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Mensagens Recebidas</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ stats.received }}</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-medium">Mensagens Enviadas</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ stats.sent }}</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de interações -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Histórico de Interações ({{ logs|length }} resultados)</h3>
            <button 
                @click="clearHistory()"
                class="px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors"
            >
                Limpar Histórico
            </button>
        </div>
        <div class="divide-y divide-gray-200">
            {% for log in logs %}
            <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-4 flex-1">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center
                            {% if log.message_type == 'RECEIVED' %}bg-blue-100{% else %}bg-green-100{% endif %}">
                            {% if log.message_type == 'RECEIVED' %}
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            {% else %}
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path>
                            </svg>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <p class="text-sm font-medium text-gray-900">{{ log.user.phone_number }}</p>
                                {% if log.user.ra %}
                                <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">RA: {{ log.user.ra }}</span>
                                {% endif %}
                                <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-700 rounded">
                                    {{ log.get_message_type_display }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700">{{ log.message_content }}</p>
                        </div>
                    </div>
                    <div class="text-right text-sm text-gray-500 ml-4">
                        <p>{{ log.created_at|date:"d/m/Y" }}</p>
                        <p>{{ log.created_at|date:"H:i:s" }}</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-12 text-center">
                <p class="text-gray-500">Nenhuma interação encontrada com os filtros aplicados</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function interactionsManager() {
    return {
        clearHistory() {
            if (!confirm('Tem certeza que deseja limpar o histórico de interações? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            // Perguntar se quer limpar tudo ou apenas por período
            const days = prompt('Limpar histórico com mais de quantos dias? (deixe vazio para limpar tudo)');
            
            const payload = {};
            if (days && !isNaN(days)) {
                payload.days = parseInt(days);
            }
            
            fetch('/api/interactions/clear/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            })
            .catch(() => {
                showToast('Erro ao limpar histórico', 'error');
            });
        }
    }
}
</script>
{% endblock %}
